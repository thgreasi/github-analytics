<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="repo-list-item">
  <template>
    <style>
      :host {
        display: block;
        line-height: 3.4em;
      }

      span {
        @apply(--paper-font-body1);
      }

      .repo-icon {
        display: inline-block;
        vertical-align: middle;
        line-height: 0.5;
      }

      .repo-name {
        font-size: 1.5em;
        vertical-align: middle;
      }

      .downloads-cont,
      .stargazers-cont {
        text-align: right;
      }

      .floatleft {
        float: left;
      }

      .floatright {
        float: right;
      }

      .clearfix:before,
      .clearfix:after {
        display: table;
        content: " ";
        clear: both;
      }

      .positive-diff {
        color: #61de61;
        font-weight: bold;
      }

      .negative-diff {
        color: red;
        font-weight: bold;
      }

    </style>

    <div class="clearfix">
      <iron-icon icon="app-svg-icons:repo-icon"></iron-icon>

      <span class="repo-name">{{ item.name }}</span>
      <span class="floatright">
        <div class="stargazers-cont">

          <span class="diff">
            <template is="dom-if" if="{{ stargazersDiff }}">
              <span class$="{{ getDiffClass(stargazersDiff) }}">
                <template is="dom-if" if="{{ isPositive(stargazersDiff) }}">+</template>
                {{ stargazersDiff }}
              </span>
            </template>
          </span>

          <span>{{ item.stargazers_count }}</span>
          <iron-icon icon="star"></iron-icon>
        </span>
        <div class="downloads-cont">
          <template is="dom-if" if="{{ item.downloads }}">

            <span class="diff">
              <template is="dom-if" if="{{ downloadsDiff }}">
                <span class$="{{ getDiffClass(downloadsDiff) }}">
                  <template is="dom-if" if="{{ isPositive(downloadsDiff) }}">+</template>
                  {{ normalizeNumberLength(downloadsDiff) }}
                </span>
              </template>
            </span>

            <span>{{ normalizeNumberLength(item.downloads) }}</span>
            <iron-icon icon="file-download"></iron-icon>
          </template>
        </span>
      </span>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'repo-list-item',

        properties: {
          item: {
            type: Object,
            notify: true,
            observer: '_itemChangedObserver',
            value: function() { return {}; }
          },
          stargazersDiff: {
            type: Number,
            readOnly: true
          },
          downloadsDiff: {
            type: Number,
            readOnly: true
          }
        },

        observers: [
            '_stargazersChanged(item.stargazers_count)',
            '_downloadsChanged(item.downloads)'
        ],

        _stargazersChanged: function (newValue) {
          let diff = this.getLastRecordsDiff(this.item && this.item.stargazersHistory);
          this._setStargazersDiff(diff);
        },

        _downloadsChanged: function (newValue) {
          let diff = this.getLastRecordsDiff(this.item && this.item.downloadsHistory);
          this._setDownloadsDiff(diff);
        },


        _itemChangedObserver: function (newValue) {
          if (newValue &&
              typeof newValue.updateDownloads === 'function') {
            newValue.updateDownloads().then((dls) => {
              console.log(`${this.item.name} dls:`,
                this.item.downloads == dls.downloads ?
                  `${this.item.downloads}` :
                  `${this.item.downloads} -> ${dls.downloads}`,
                ` historyLen: ${this.item.downloadsHistory && this.item.downloadsHistory.length}`);

              this.notifyPath('item.downloads', dls.downloads);
            });
          }
        },

        getLastRecordsDiff: function (array) {
          if (array &&
              array.length >= 2) {
            let len = array.length;
            return array[len - 1].value - array[len - 2].value;
          }
          return 0;
        },

        isPositive: function (number) {
          return number > 0;
        },

        isNegative: function (number) {
          return number < 0;
        },

        getDiffClass: function (diff) {
          if (diff > 0) {
            return 'positive-diff';
          }
          if (diff < 0) {
            return 'negative-diff';
          }
        },

        normalizeNumberLength: function (num) {
          var x = [
            '',
            'K',
            'M'
          ];
          return num;
        }
      });
    })();
  </script>
</dom-module>
