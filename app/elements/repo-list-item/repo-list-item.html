<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="repo-list-item">
  <template>
    <style>
      :host {
        display: flex;
        line-height: 1em;
        flex-flow: row;
      }

      .reponame-cont {
        flex: 1 0 0;
        display: inline-block;
        width: auto;
        line-height: 3em;
      }

      .stats-cont {
        flex: 0 0px 0px;
        display: flex;
        flex-flow: column;
      }

      .stargazers-cont,
      .downloads-cont {
        flex: 1;
        display: inline-block;
      }

      span {
        @apply(--paper-font-body1);
      }

      .repo-icon {
        display: inline-block;
        vertical-align: middle;
        line-height: 0.5;
      }

      .repo-name {
        font-size: 1.5em;
        vertical-align: middle;
      }

      .downloads-cont,
      .stargazers-cont {
        text-align: right;
      }

      .positive-diff {
        color: #61de61;
        font-weight: bold;
      }

      .negative-diff {
        color: red;
        font-weight: bold;
      }

    </style>

    <div class="reponame-cont">
      <template is="dom-if" if="{{!item.fork}}">
        <iron-icon icon="app-svg-icons:repo-icon"></iron-icon>
      </template>

      <template is="dom-if" if="{{item.fork}}">
        <iron-icon icon="app-svg-icons:repo-forked-icon"></iron-icon>
      </template>

      <span class="repo-name">{{ item.name }}</span>
    </div>

    <div class="stats-cont">
      <div class="stargazers-cont">
        <span class="diff">
          <template is="dom-if" if="{{ stargazersDiff }}">
            <span class$="{{ getDiffClass(stargazersDiff) }}">
              <template is="dom-if" if="{{ isPositive(stargazersDiff) }}">+</template>
              {{ normalizeNumberLength(stargazersDiff) }}
            </span>
          </template>
        </span>

        <span>{{ normalizeNumberLength(item.stargazers_count) }}</span>
        <iron-icon icon="star"></iron-icon>
      </div>

      <div class="downloads-cont">
        <template is="dom-if" if="{{ item.downloads }}">

          <span class="diff">
            <template is="dom-if" if="{{ downloadsDiff }}">
              <span class$="{{ getDiffClass(downloadsDiff) }}">
                <template is="dom-if" if="{{ isPositive(downloadsDiff) }}">+</template>
                {{ normalizeNumberLength(downloadsDiff) }}
              </span>
            </template>
          </span>

          <span>{{ normalizeNumberLength(item.downloads) }}</span>
          <iron-icon icon="file-download"></iron-icon>
        </template>
      </div>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'repo-list-item',

        properties: {
          item: {
            type: Object,
            notify: true,
            observer: '_itemChangedObserver',
            value: function() { return {}; }
          },
          stargazersDiff: {
            type: Number,
            readOnly: true
          },
          downloadsDiff: {
            type: Number,
            readOnly: true
          }
        },

        observers: [
            '_stargazersChanged(item.stargazers_count)',
            '_downloadsChanged(item.downloads)'
        ],

        _stargazersChanged: function (newValue) {
          let diff = this.getLastRecordsDiff(this.item && this.item.stargazersHistory);
          this._setStargazersDiff(diff);
        },

        _downloadsChanged: function (newValue) {
          let diff = this.getLastRecordsDiff(this.item && this.item.downloadsHistory);
          this._setDownloadsDiff(diff);
        },


        _itemChangedObserver: function (newValue) {
          if (newValue &&
              typeof newValue.updateDownloads === 'function') {
            newValue.updateDownloads().then((dls) => {
              // console.log(`${this.item.name} dls:`,
              //   this.item.downloads == dls.downloads ?
              //     `${this.item.downloads}` :
              //     `${this.item.downloads} -> ${dls.downloads}`,
              //   ` historyLen: ${this.item.downloadsHistory && this.item.downloadsHistory.length}`);

              this.notifyPath('item.downloads', dls.downloads);
            });
          }
        },

        getLastRecordsDiff: function (array) {
          if (array &&
              array.length >= 2) {
            let len = array.length;
            return array[len - 1].value - array[len - 2].value;
          }
          return 0;
        },

        isPositive: function (number) {
          return number > 0;
        },

        isNegative: function (number) {
          return number < 0;
        },

        getDiffClass: function (diff) {
          if (diff > 0) {
            return 'positive-diff';
          }
          if (diff < 0) {
            return 'negative-diff';
          }
        },

        normalizeNumberLength: function (num) {
          var scaleLiterals = [
            'k',
            'm',
            'b',
            't'
          ];

          var sign = num < 0 ? '-' : '';
          var scale = Math.min(Math.log10(Math.abs(num)) | 0, scaleLiterals.length * 3);
          if (scale >= 3) {
            var tmp = Math.abs(num) / Math.pow(10, scale);
            if (scale % 3 === 0) {
              tmp = ((10 * tmp) | 0) / 10;
            } else {
              tmp = tmp | 0;
            }
            return sign + tmp + scaleLiterals[((scale / 3) | 0) - 1];
          }
          
          return num;
        }
      });
    })();
  </script>
</dom-module>
